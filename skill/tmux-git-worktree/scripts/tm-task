#!/bin/bash
# tm-task - Main CLI

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SKILL_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

source "${SKILL_ROOT}/scripts/lib/tmux.sh"
source "${SKILL_ROOT}/scripts/lib/git-worktree.sh"
source "${SKILL_ROOT}/scripts/lib/skills.sh"
source "${SKILL_ROOT}/scripts/lib/cleanup.sh"
source "${SKILL_ROOT}/scripts/lib/ai-launch.sh"
source "${SKILL_ROOT}/scripts/lib/config/tm-task.conf"

usage() {
    cat <<EOF
tm-task - In-place context swap for developers

USAGE:
    tm-task <branch-name> <task-description> [ai-command]

ARGUMENTS:
    branch-name        Git branch to create
    task-description   Task description (injected into AI context)
    ai-command         AI command (default: claude)

ENVIRONMENT:
    TM_TASK_WORKTREE_BASE  Worktree dir (default: ~/.local/tmux-git-worktrees)
    TM_TASK_SKILL_ENABLED  Enable skills (default: true)
    TM_TASK_DEBUG          Debug logging (default: false)
    TM_TASK_AI_CMD_<tool>  Custom AI launch command (e.g., TM_TASK_AI_CMD_CLAUDE)

EXAMPLES:
    tm-task fix-bug "fix login interface CSRF vulnerability"
    tm-task feature "Add OAuth2" codex
    tm-task test "Try something" none

    # Custom AI command
    TM_TASK_AI_CMD_MYAI="my-ai-wrapper" tm-task my-task "description" myai

EOF
    exit 1
}

log() {
    if [[ "${DEBUG}" == "true" ]]; then
        echo "[tm-task] $*" >&2
    fi
}

error() {
    echo "[tm-task ERROR] $*" >&2
    exit 1
}

validate_requirements() {
    if ! tmux_inside; then
        error "Not in tmux session"
    fi
    if ! git_worktree_check_repo; then
        error "Not in git repo"
    fi
    if ! git worktree --help >/dev/null 2>&1; then
        error "git worktree not supported (need 2.5+)"
    fi
}

validate_branch_name() {
    local branch_name="$1"
    if [[ -z "$branch_name" ]]; then
        error "Branch name required"
    fi
    if [[ ! "$branch_name" =~ ^[a-zA-Z0-9_-]+$ ]]; then
        error "Invalid branch name: $branch_name"
    fi
    if git show-ref --verify --quiet "refs/heads/$branch_name" 2>/dev/null; then
        error "Branch '$branch_name' exists"
    fi
}

main() {
    if [[ $# -lt 2 ]]; then
        usage
    fi

    local branch_name="$1"
    local task_description="$2"
    local ai_command="${3:-claude}"

    validate_requirements
    validate_branch_name "$branch_name"

    log "Branch: $branch_name"
    log "Task: $task_description"
    log "AI: $ai_command"

    local original_path
    original_path=$(pwd)

    local base_branch="${BASE_BRANCH}"
    if [[ -z "$base_branch" ]]; then
        base_branch=$(git_worktree_get_base_branch)
    fi

    local worktree_path
    worktree_path=$(git_worktree_create "$branch_name")

    # Create new window for the task (using branch name as window name)
    local task_window
    task_window=$(tmux_create_task_window "$branch_name" "$worktree_path")

    # Setup cleanup with new window mode
    cleanup_setup "$task_window" "$worktree_path" "$branch_name"

    # Generate initial prompt for AI
    local initial_prompt=""
    if [[ "${SKILL_ENABLED:-true}" == "true" ]]; then
        initial_prompt=$(skills_generate_prompt "$task_description" "$branch_name" "$base_branch" "$worktree_path" "$original_path")
    fi

    # Display task context
    cat <<EOF

========================================
 tm-task: Task Environment Ready
========================================

Branch: $branch_name
Worktree: $worktree_path
Base: $base_branch

Task: $task_description

Switch to the new window to begin work.
Close the window when done to auto-cleanup.

========================================

EOF

    # Launch AI tool with initial prompt
    ai_launch "$ai_command" "$initial_prompt" "$worktree_path" "$task_window"
}

main "$@"
